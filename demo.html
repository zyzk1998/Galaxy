<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Agent Demo (Auto-Routing)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        /* Light Theme Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å·¥å…·é«˜äº®åŠ¨ç”» */
        @keyframes pulse-purple {
            0%, 100% { background-color: white; border-color: transparent; }
            50% { background-color: #f3e8ff; border-color: #9333ea; transform: scale(1.02); }
        }
        .tool-active {
            animation: pulse-purple 1.5s infinite;
            border: 1px solid #9333ea !important;
            color: #9333ea !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-6 shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="bg-purple-600 text-white p-2 rounded-lg">
                <i class="fas fa-dna"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg tracking-tight">Galaxy Orchestrator</h1>
                <p class="text-xs text-gray-500">Intelligent Bioinformatics Agent</p>
            </div>
        </div>
        <div class="flex items-center gap-3 text-xs font-mono">
            <div id="model-badge" class="px-2 py-1 rounded bg-gray-100 text-gray-500 transition-colors">
                <i class="fas fa-brain mr-1"></i> <span id="current-model-display">Waiting...</span>
            </div>
            <div class="text-gray-400">
                <span id="status-indicator" class="inline-block w-2 h-2 rounded-full bg-gray-300 mr-1"></span>
                System Status
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Tools & Admin -->
        <aside class="w-72 bg-gray-100 border-r border-gray-200 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
            
            <!-- 1. Tools Section (Galaxy Style) -->
            <div class="flex-1 overflow-y-auto p-4">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 px-2">
                    <i class="fas fa-tools mr-1"></i> Available Tools
                </h2>
                
                <!-- å·¥å…·åˆ—è¡¨å®¹å™¨ -->
                <div id="tools-list" class="space-y-2">
                    <!-- JS å°†åŠ¨æ€å¡«å……è¿™é‡Œ -->
                </div>
            </div>

            <!-- 2. Admin Section: Configuration (Collapsible) -->
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <details class="group bg-white rounded-lg border border-gray-200 open:shadow-lg transition-all duration-200">
                    <summary class="list-none flex items-center justify-between p-3 cursor-pointer text-xs font-bold text-gray-500 uppercase hover:text-purple-600">
                        <span><i class="fas fa-cog mr-1"></i> System Admin</span>
                        <span class="transition group-open:rotate-180"><i class="fas fa-chevron-down"></i></span>
                    </summary>
                    <div class="p-3 pt-0 border-t border-gray-100 space-y-4 mt-2">
                        
                        <!-- Galaxy Config -->
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">Galaxy URL</label>
                            <input id="cfg-galaxy-url" type="text" value="http://localhost:8080" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 focus:border-purple-500 outline-none">
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">Galaxy API Key</label>
                            <input id="cfg-api-key" type="password" placeholder="Paste API Key Here" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 focus:border-purple-500 outline-none font-mono">
                        </div>

                        <div class="border-t border-gray-100 my-2"></div>

                        <!-- Ollama Config -->
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 mb-1">Ollama URL</label>
                            <input id="cfg-ollama-url" type="text" value="http://localhost:11434" class="w-full bg-gray-50 border border-gray-200 rounded p-2 text-xs text-gray-700 focus:border-purple-500 outline-none">
                        </div>

                        <!-- Model Auto-Routing Config -->
                        <div>
                            <label class="block text-[10px] font-bold text-blue-500 mb-1"><i class="fas fa-comments"></i> Chat Model (Text)</label>
                            <input id="cfg-text-model" type="text" value="gpt-oss:120b" class="w-full bg-blue-50 border border-blue-100 rounded p-2 text-xs text-gray-700 focus:border-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-purple-500 mb-1"><i class="fas fa-file-alt"></i> Data Model (Multimodal)</label>
                            <input id="cfg-data-model" type="text" value="qwen3-embedding:4b" class="w-full bg-purple-50 border border-purple-100 rounded p-2 text-xs text-gray-700 focus:border-purple-500 outline-none">
                        </div>

                        <button onclick="saveAdminConfig()" class="w-full bg-gray-800 hover:bg-gray-700 text-white text-xs py-2 rounded shadow-sm transition-all">
                            Save Configuration
                        </button>
                        <p id="save-status" class="text-center text-[10px] text-green-500 mt-1 opacity-0">Saved to LocalStorage</p>
                    </div>
                </details>

                <!-- Footer -->
                <div class="mt-4 text-center">
                     <p class="text-[10px] text-gray-400">Â© 2024 Galaxy Orchestrator</p>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50 relative">
            
            <!-- Chat Container -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-8 space-y-6">
                <!-- Welcome Card -->
                <div class="flex justify-start animate-fade-in">
                    <div class="bg-white p-6 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 max-w-2xl">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="bg-purple-100 text-purple-600 w-8 h-8 flex items-center justify-center rounded-lg">
                                <i class="fas fa-robot"></i>
                            </div>
                            <span class="font-bold text-gray-800">AI Assistant</span>
                        </div>
                        <p class="text-gray-600 text-sm leading-relaxed mb-4">
                            ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ç”Ÿç‰©ä¿¡æ¯å­¦åŠ©æ‰‹ã€‚
                            <br>æˆ‘ä¼šæ ¹æ®ä½ çš„éœ€æ±‚è‡ªåŠ¨é€‰æ‹©æ¨¡å‹ï¼š
                            <span class="bg-blue-100 text-blue-800 text-xs px-1 rounded">æ™®é€šå¯¹è¯</span> æˆ– 
                            <span class="bg-purple-100 text-purple-800 text-xs px-1 rounded">æ•°æ®åˆ†æ</span>ã€‚
                        </p>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <p class="text-xs font-bold text-gray-500 uppercase mb-2">æ‚¨å¯ä»¥å°è¯•ï¼š</p>
                            <ul class="text-sm text-gray-600 space-y-2">
                                <li class="flex items-center gap-2 cursor-pointer hover:text-purple-600" onclick="setInput('ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶')">
                                    <i class="fas fa-file-upload text-gray-400"></i> "ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶"
                                </li>
                                <li class="flex items-center gap-2 cursor-pointer hover:text-purple-600" onclick="setInput('è¿‡æ»¤å‡ºåŒ…å« gene_A çš„è¡Œ')">
                                    <i class="fas fa-filter text-gray-400"></i> "è¿‡æ»¤å‡ºåŒ…å« gene_A çš„è¡Œ"
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-6 bg-white border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.02)] z-20">
                <div class="max-w-4xl mx-auto flex gap-3 items-end">
                    
                    <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">
                    <button onclick="document.getElementById('file-upload').click()" class="p-3 bg-gray-100 hover:bg-gray-200 text-gray-500 rounded-xl transition-colors" title="Upload File">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    
                    <div class="flex-1 relative">
                        <textarea id="user-input" rows="1" placeholder="è¾“å…¥æŒ‡ä»¤..." class="w-full bg-gray-50 text-gray-800 p-3 pl-4 pr-12 rounded-xl border border-gray-200 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all resize-none shadow-inner" style="min-height: 50px;" onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                        <div class="absolute right-3 bottom-3 text-xs text-gray-400 pointer-events-none">
                            <span class="border border-gray-200 rounded px-1">â†µ</span>
                        </div>
                    </div>
                    
                    <button onclick="sendMessage()" class="p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl shadow-lg shadow-purple-200 transition-transform transform active:scale-95">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-400">Powered by Ollama & Galaxy Project</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ==========================================
        // 1. KNOWLEDGE BASE (Internal RAG)
        // ==========================================
        
        const INTERNAL_KNOWLEDGE_BASE = [
            {
                name: "text_filter",
                displayName: "Text Filter (Grep)",
                icon: "fa-filter",
                description: "Filter lines in a dataset based on a pattern.",
                mapping: {
                    toolId: "Filter1", 
                    params: { "dataset_id": "input", "pattern": "cond" }
                },
                schema: {
                    type: "object",
                    properties: {
                        dataset_id: { type: "string" },
                        pattern: { type: "string", description: "Regex keyword" }
                    },
                    required: ["dataset_id", "pattern"]
                }
            },
            {
                name: "head_tool",
                displayName: "Select First Lines",
                icon: "fa-align-left",
                description: "Select first N lines from a dataset.",
                mapping: {
                    toolId: "Show beginning1",
                    params: { "dataset_id": "input", "lines": "lineNum" }
                },
                schema: {
                    type: "object",
                    properties: {
                        dataset_id: { type: "string" },
                        lines: { type: "integer", description: "Number of lines" }
                    },
                    required: ["dataset_id"]
                }
            },
            {
                name: "fastqc",
                displayName: "FastQC Report",
                icon: "fa-chart-bar",
                description: "Run quality control checks on raw sequence data.",
                mapping: {
                    toolId: "toolshed.g2.bx.psu.edu/repos/devteam/fastqc/fastqc/0.72",
                    params: { "dataset_id": "input_file" }
                },
                schema: {
                    type: "object",
                    properties: { dataset_id: { type: "string" } },
                    required: ["dataset_id"]
                }
            }
        ];

        // ==========================================
        // 2. INITIALIZATION & ADMIN
        // ==========================================
        const CONFIG_KEY = 'galaxy_admin_v2';
        let currentHistoryId = null;
        let lastUploadedDatasetId = null;

        window.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            renderSidebarTools();
        });

        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                const cfg = JSON.parse(saved);
                document.getElementById('cfg-galaxy-url').value = cfg.galaxyUrl || 'http://localhost:8080';
                document.getElementById('cfg-api-key').value = cfg.apiKey || '';
                document.getElementById('cfg-ollama-url').value = cfg.ollamaUrl || 'http://localhost:11434';
                document.getElementById('cfg-text-model').value = cfg.textModel || 'gpt-oss:120b';
                document.getElementById('cfg-data-model').value = cfg.dataModel || 'qwen3-embedding:4b';
                
                if(cfg.apiKey) {
                    document.getElementById('status-indicator').classList.remove('bg-gray-300');
                    document.getElementById('status-indicator').classList.add('bg-green-400');
                }
            }
            // Init model display
            updateModelDisplay('text');
        }

        function saveAdminConfig() {
            const cfg = {
                galaxyUrl: document.getElementById('cfg-galaxy-url').value,
                apiKey: document.getElementById('cfg-api-key').value,
                ollamaUrl: document.getElementById('cfg-ollama-url').value,
                textModel: document.getElementById('cfg-text-model').value,
                dataModel: document.getElementById('cfg-data-model').value
            };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
            
            const msg = document.getElementById('save-status');
            msg.style.opacity = 1;
            document.getElementById('status-indicator').classList.remove('bg-gray-300');
            document.getElementById('status-indicator').classList.add('bg-green-400');
            setTimeout(() => msg.style.opacity = 0, 2000);
        }

        function renderSidebarTools() {
            const container = document.getElementById('tools-list');
            container.innerHTML = '';
            
            INTERNAL_KNOWLEDGE_BASE.forEach(tool => {
                const div = document.createElement('div');
                div.id = `tool-item-${tool.name}`;
                div.className = 'flex items-center gap-3 p-3 bg-white rounded-lg border border-gray-200 text-gray-600 text-sm transition-all duration-300';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded bg-gray-100 flex items-center justify-center text-gray-400">
                        <i class="fas ${tool.icon}"></i>
                    </div>
                    <div>
                        <div class="font-bold text-gray-700">${tool.displayName}</div>
                        <div class="text-[10px] text-gray-400 truncate w-32">${tool.description}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function highlightTool(toolName) {
            const el = document.getElementById(`tool-item-${toolName}`);
            if (el) {
                // remove existing class to restart animation
                el.classList.remove('tool-active');
                void el.offsetWidth; // trigger reflow
                el.classList.add('tool-active');
                
                // Scroll to view
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function getConfig() {
            return {
                galaxyUrl: document.getElementById('cfg-galaxy-url').value.replace(/\/$/, ''),
                apiKey: document.getElementById('cfg-api-key').value,
                ollamaUrl: document.getElementById('cfg-ollama-url').value.replace(/\/$/, ''),
                textModel: document.getElementById('cfg-text-model').value,
                dataModel: document.getElementById('cfg-data-model').value
            };
        }

        function updateModelDisplay(type) {
            const cfg = getConfig();
            const badge = document.getElementById('model-badge');
            const txt = document.getElementById('current-model-display');
            
            if (type === 'data') {
                badge.className = 'px-2 py-1 rounded bg-purple-100 text-purple-700 transition-colors border border-purple-200';
                txt.textContent = cfg.dataModel;
            } else {
                badge.className = 'px-2 py-1 rounded bg-blue-100 text-blue-700 transition-colors border border-blue-200';
                txt.textContent = cfg.textModel;
            }
        }

        function setInput(text) {
            document.getElementById('user-input').value = text;
        }

        // --- UI Helpers ---
        function addMessage(role, content, isHtml = false) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubble = document.createElement('div');
            if (role === 'user') {
                bubble.className = 'bg-purple-600 text-white p-4 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[80%]';
            } else {
                bubble.className = 'bg-white text-gray-700 p-4 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 text-sm max-w-[80%]';
            }
            
            if (isHtml) bubble.innerHTML = content;
            else bubble.textContent = content;

            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        // --- Galaxy API ---
        async function galaxyFetch(endpoint, method = 'GET', body = null) {
            const cfg = getConfig();
            if (!cfg.apiKey) { alert('API Key ç¼ºå¤±'); throw new Error('No API Key'); }
            
            const opts = {
                method,
                headers: { 'x-api-key': cfg.apiKey, 'Content-Type': 'application/json' }
            };
            if (body) opts.body = JSON.stringify(body);

            try {
                const res = await fetch(`${cfg.galaxyUrl}${endpoint}`, opts);
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            } catch (e) {
                console.error(e);
                throw e;
            }
        }

        async function ensureHistory() {
            if (currentHistoryId) return currentHistoryId;
            try {
                const hists = await galaxyFetch('/api/histories?order=update_time');
                if (hists.length > 0) currentHistoryId = hists[0].id;
                else {
                    const newHist = await galaxyFetch('/api/histories', 'POST', { name: 'Agent Session ' + new Date().toISOString() });
                    currentHistoryId = newHist.id;
                }
                return currentHistoryId;
            } catch(e) { return null; }
        }

        // ==========================================
        // 3. CORE INTELLIGENCE
        // ==========================================

        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            addMessage('user', `ğŸ“„ ä¸Šä¼ æ–‡ä»¶: ${file.name}`);
            addMessage('assistant', `æ­£åœ¨å°†æ–‡ä»¶ä¸Šä¼ è‡³ Galaxy... <i class="fas fa-spinner fa-spin"></i>`, true);
            
            // Switch UI to Data Mode
            updateModelDisplay('data');

            try {
                const histId = await ensureHistory();
                if(!histId) throw new Error("æ— æ³•è¿æ¥ Galaxy");

                const text = await file.text();
                const payload = {
                    tool_id: 'upload1',
                    history_id: histId,
                    inputs: {
                        'files_0|type': 'upload_dataset',
                        'files_0|NAME': file.name,
                        'files_0|url_paste': text,
                        'dbkey': '?',
                        'file_type': 'auto',
                    }
                };

                const res = await galaxyFetch('/api/tools', 'POST', payload);
                const datasetId = res.outputs[0].id;
                lastUploadedDatasetId = datasetId;
                
                addMessage('assistant', `âœ… <b>æ–‡ä»¶å·²å°±ç»ª</b><br>Dataset ID: <code>${datasetId}</code><br>ç³»ç»Ÿå·²åˆ‡æ¢è‡³åˆ†ææ¨¡å‹ï¼Œæ‚¨å¯ä»¥è®©æˆ‘è¿‡æ»¤æˆ–ç»Ÿè®¡è¯¥æ–‡ä»¶ã€‚`, true);

            } catch (e) {
                addMessage('assistant', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`);
            }
        }

        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            if (!text) return;
            
            inputEl.value = '';
            addMessage('user', text);
            addMessage('assistant', `æ€è€ƒä¸­...`, true);

            const cfg = getConfig();
            
            // --- Auto-Routing Logic ---
            // If we have a file context or user mentions "dataset", use Data Model.
            const hasDataCtx = !!lastUploadedDatasetId;
            const modelToUse = hasDataCtx ? cfg.dataModel : cfg.textModel;
            
            updateModelDisplay(hasDataCtx ? 'data' : 'text');
            
            // Prepare Tools
            const availableTools = INTERNAL_KNOWLEDGE_BASE.map(t => ({
                name: t.name,
                description: t.description,
                parameters: t.schema
            }));

            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªç”Ÿç‰©ä¿¡æ¯å­¦ä¸“å®¶ Agentã€‚
å½“å‰è¿è¡Œæ¨¡å‹: ${modelToUse}ã€‚
ä¸Šä¸‹æ–‡ä¿¡æ¯:
- æœ€è¿‘ä¸Šä¼ æ–‡ä»¶ ID: "${lastUploadedDatasetId || 'æ— '}".
- ç”¨æˆ·è¾“å…¥: "${text}".

é€»è¾‘åˆ¤æ–­:
1. å¦‚æœç”¨æˆ·è¯·æ±‚å¯ä»¥ç”¨å·¥å…·è§£å†³ (å¦‚è¿‡æ»¤, ç»Ÿè®¡, è´¨æ§)ï¼Œè¯·è¾“å‡ºæ ‡å‡† JSON æ ¼å¼è°ƒç”¨å·¥å…·ã€‚
2. å¦åˆ™ï¼Œè¯·ç”¨ä¸­æ–‡ç›´æ¥å›ç­”ã€‚

å¯ç”¨å·¥å…·: ${JSON.stringify(availableTools)}
            `;

            try {
                const ollamaRes = await fetch(`${cfg.ollamaUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: modelToUse,
                        stream: false,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        format: "json" 
                    })
                });

                if (!ollamaRes.ok) throw new Error(`Ollama Error: ${ollamaRes.statusText}`);
                const ollamaJson = await ollamaRes.json();
                let content = ollamaJson.message.content;

                // Parse Tool Call
                let toolCall = null;
                try {
                    const match = content.match(/\{[\s\S]*\}/);
                    if (match) toolCall = JSON.parse(match[0]);
                    if (toolCall && !toolCall.tool && toolCall.name) toolCall.tool = toolCall.name;
                } catch (e) {}

                if (toolCall && toolCall.tool) {
                    const toolDef = INTERNAL_KNOWLEDGE_BASE.find(t => t.name === toolCall.tool);
                    
                    if (toolDef) {
                        // VISUAL FEEDBACK: Highlight Sidebar
                        highlightTool(toolDef.name);
                        
                        addMessage('assistant', `âš™ï¸ <b>æ­£åœ¨è°ƒç”¨å·¥å…·:</b> ${toolDef.displayName}...`, true);
                        await runGalaxyTool(toolDef, toolCall.parameters);
                    } else {
                        // Handle hallucination or chat
                        if (toolCall.message) addMessage('assistant', toolCall.message);
                        else addMessage('assistant', `æ¨¡å‹å°è¯•è°ƒç”¨æœªçŸ¥å·¥å…·: ${toolCall.tool}`);
                    }
                } else {
                    if (toolCall && toolCall.message) content = toolCall.message;
                    addMessage('assistant', content);
                }

            } catch (e) {
                addMessage('assistant', `System Error: ${e.message}`);
            }
        }

        async function runGalaxyTool(toolDef, params) {
            const histId = await ensureHistory();
            if(!histId) return;

            // Context Injection
            if (!params.dataset_id && lastUploadedDatasetId) {
                params.dataset_id = lastUploadedDatasetId;
            }

            // Parameter Mapping
            const payload = {
                tool_id: toolDef.mapping.toolId,
                history_id: histId,
                inputs: {}
            };

            for (const [key, val] of Object.entries(params)) {
                const galaxyKey = toolDef.mapping.params[key];
                if (galaxyKey) {
                    if (key === 'dataset_id') payload.inputs[galaxyKey] = { src: 'hda', id: val };
                    else payload.inputs[galaxyKey] = val;
                }
            }

            try {
                const toolRes = await galaxyFetch('/api/tools', 'POST', payload);
                const jobId = toolRes.jobs[0].id;
                
                addMessage('assistant', `ä»»åŠ¡å·²æäº¤ Galaxy (Job: ${jobId})<br>ç­‰å¾…ç»“æœä¸­...`, true);
                
                // Polling
                const pollInterval = setInterval(async () => {
                    const job = await galaxyFetch(`/api/jobs/${jobId}`);
                    if (job.state === 'ok') {
                        clearInterval(pollInterval);
                        addMessage('assistant', `âœ… <b>åˆ†æå®Œæˆ</b><br>ç»“æœ Dataset ID: ${job.outputs[0].id}`, true);
                    } else if (job.state === 'error') {
                        clearInterval(pollInterval);
                        addMessage('assistant', `âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ã€‚`, true);
                    }
                }, 2000);

            } catch (e) {
                addMessage('assistant', `âŒ è°ƒç”¨å¤±è´¥: ${e.message}`);
            }
        }
    </script>
</body>
</html>