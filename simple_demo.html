<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Agent æç®€æ¼”ç¤ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        .log-entry { font-family: monospace; font-size: 0.85em; border-left: 2px solid #555; padding-left: 8px; margin-top: 4px; color: #aaa; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center gap-2 text-purple-400 font-bold text-xl">
            <i class="fas fa-dna"></i> Galaxy Agent Demo
        </div>
        <div class="text-xs text-gray-500">å•æ–‡ä»¶æ¼”ç¤ºç‰ˆ | æ— éœ€æ„å»º</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
        <aside class="w-1/3 min-w-[300px] bg-gray-800 p-4 overflow-y-auto border-r border-gray-700">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4 tracking-wider">ç¯å¢ƒé…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Galaxy URL</label>
                    <input id="cfg-galaxy-url" type="text" value="http://192.168.32.31" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Galaxy API Key <span class="text-red-400">*</span></label>
                    <input id="cfg-api-key" type="password" placeholder="ç²˜è´´ä½ çš„ Key" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Ollama URL</label>
                    <input id="cfg-ollama-url" type="text" value="http://192.168.32.31:11434" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
                </div>
                <div>
                    <label class="block text-xs text-gray-500 mb-1">Ollama Model</label>
                    <input id="cfg-model" type="text" value="gpt-oss:120b" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
                </div>

                <hr class="border-gray-700 my-4">

                <h2 class="text-sm font-bold text-gray-400 uppercase mb-2 tracking-wider">çŸ¥è¯†åº“ (RAG æ˜ å°„)</h2>
                <div class="bg-gray-900 p-3 rounded text-xs font-mono text-gray-400">
                    <p class="mb-2 text-green-400">// è¿™é‡Œæ¨¡æ‹Ÿ constants.ts</p>
                    <label class="block mb-1 text-gray-500">Text Filter çœŸå® ID:</label>
                    <input id="cfg-tool-id" type="text" value="Filter1" class="w-full bg-gray-800 border border-gray-700 rounded p-1 mb-2 text-white">
                    <p class="text-[10px] text-gray-500">å°† "dataset_id" æ˜ å°„ä¸º -> "input" (hda_ref)</p>
                    <p class="text-[10px] text-gray-500">å°† "pattern" æ˜ å°„ä¸º -> "cond"</p>
                </div>
            </div>

            <div id="logs" class="mt-6 space-y-2">
                <h3 class="text-xs font-bold text-gray-500 uppercase">ç³»ç»Ÿæ—¥å¿—</h3>
                <!-- Logs will appear here -->
            </div>
        </aside>

        <!-- å³ä¾§èŠå¤©åŒº -->
        <main class="flex-1 flex flex-col bg-gray-900">
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex justify-start">
                    <div class="bg-gray-800 p-3 rounded-lg rounded-bl-none max-w-[80%] border border-gray-700">
                        <p>ä½ å¥½ï¼æˆ‘æ˜¯ Galaxy æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·å…ˆåœ¨å·¦ä¾§å¡«å…¥ API Keyï¼Œç„¶åä¸Šä¼ æ–‡ä»¶ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex gap-2">
                <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('file-upload').click()" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input id="user-input" type="text" placeholder="è¾“å…¥æŒ‡ä»¤ (ä¾‹å¦‚: è¿‡æ»¤åŒ…å« gene_A çš„è¡Œ)" class="flex-1 bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:border-purple-500" onkeydown="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()" class="p-3 bg-purple-600 hover:bg-purple-700 rounded-lg text-white font-bold shadow-lg transition">
                    å‘é€
                </button>
            </div>
        </main>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let currentHistoryId = null;
        let lastUploadedDatasetId = null;

        // --- è¾…åŠ©å‡½æ•°ï¼šå†™æ—¥å¿— ---
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-green-400' : 'text-gray-400');
            entry.innerHTML = `<span class="${color}">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
            logs.prepend(entry);
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ èŠå¤©æ°”æ³¡ ---
        function addMessage(role, content, isHtml = false) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = role === 'user' 
                ? 'bg-purple-600 text-white p-3 rounded-lg rounded-br-none max-w-[80%] shadow-md' 
                : 'bg-gray-800 text-gray-200 p-3 rounded-lg rounded-bl-none max-w-[80%] border border-gray-700 shadow-md';
            
            if (isHtml) bubble.innerHTML = content;
            else bubble.textContent = content;

            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        // --- 1. è·å–é…ç½® ---
        function getConfig() {
            return {
                galaxyUrl: document.getElementById('cfg-galaxy-url').value.replace(/\/$/, ''),
                apiKey: document.getElementById('cfg-api-key').value,
                ollamaUrl: document.getElementById('cfg-ollama-url').value.replace(/\/$/, ''),
                model: document.getElementById('cfg-model').value,
                realToolId: document.getElementById('cfg-tool-id').value // çŸ¥è¯†åº“ä¸­çš„åŠ¨æ€éƒ¨åˆ†
            };
        }

        // --- 2. Galaxy API äº¤äº’ ---
        async function galaxyFetch(endpoint, method = 'GET', body = null) {
            const cfg = getConfig();
            if (!cfg.apiKey) { alert('è¯·è¾“å…¥ Galaxy API Key!'); throw new Error('No API Key'); }
            
            const opts = {
                method,
                headers: { 'x-api-key': cfg.apiKey, 'Content-Type': 'application/json' }
            };
            if (body) opts.body = JSON.stringify(body);

            try {
                const res = await fetch(`${cfg.galaxyUrl}${endpoint}`, opts);
                if (!res.ok) throw new Error(await res.text());
                return await res.json();
            } catch (e) {
                log(`Galaxy API Error: ${e.message}`, 'error');
                throw e;
            }
        }

        // --- 3. åˆå§‹åŒ–/è·å– History ---
        async function ensureHistory() {
            if (currentHistoryId) return currentHistoryId;
            log('æ­£åœ¨æ£€æŸ¥ Galaxy History...');
            const hists = await galaxyFetch('/api/histories?order=update_time');
            if (hists.length > 0) {
                currentHistoryId = hists[0].id;
                log(`ä½¿ç”¨å·²æœ‰ History: ${hists[0].name} (${currentHistoryId})`, 'success');
            } else {
                const newHist = await galaxyFetch('/api/histories', 'POST', { name: 'Demo Session' });
                currentHistoryId = newHist.id;
                log(`åˆ›å»ºæ–° History: ${newHist.id}`, 'success');
            }
            return currentHistoryId;
        }

        // --- 4. ä¸Šä¼ æ–‡ä»¶ ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const cfg = getConfig();
            if (!cfg.apiKey) return alert("è¯·å…ˆå¡«å†™ Galaxy API Key");

            addMessage('user', `ä¸Šä¼ æ–‡ä»¶: ${file.name}`);
            addMessage('assistant', `æ­£åœ¨ä¸Šä¼ åˆ° Galaxy... <i class="fas fa-spinner fa-spin"></i>`, true);

            try {
                const histId = await ensureHistory();
                const text = await file.text(); // ç®€åŒ–æ¼”ç¤ºï¼šåªå¤„ç†æ–‡æœ¬

                // æ„é€  Galaxy upload payload
                const payload = {
                    tool_id: 'upload1',
                    history_id: histId,
                    inputs: {
                        'files_0|type': 'upload_dataset',
                        'files_0|NAME': file.name,
                        'files_0|url_paste': text,
                        'dbkey': '?',
                        'file_type': 'auto',
                    }
                };

                const res = await galaxyFetch('/api/tools', 'POST', payload);
                const datasetId = res.outputs[0].id;
                lastUploadedDatasetId = datasetId;
                
                log(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸã€‚Dataset ID: ${datasetId}`, 'success');
                addMessage('assistant', `âœ… ä¸Šä¼ æˆåŠŸï¼<br>Dataset ID: <b>${datasetId}</b><br>ç°åœ¨ä½ å¯ä»¥é—®æˆ‘å¦‚ä½•å¤„ç†å®ƒã€‚`, true);

            } catch (e) {
                addMessage('assistant', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`);
            }
        }

        // --- 5. ä¸»æµç¨‹ï¼šLLM å†³ç­– + å·¥å…·æ‰§è¡Œ ---
        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            if (!text) return;
            
            inputEl.value = '';
            addMessage('user', text);
            addMessage('assistant', `Thinking... <i class="fas fa-brain fa-pulse"></i>`, true);

            const cfg = getConfig();

            // 5.1 æ„å»º Prompt (åŒ…å«ç®€å•çš„çŸ¥è¯†åº“)
            const toolDef = {
                name: "text_filter",
                description: "Filter lines in a dataset based on a pattern.",
                parameters: {
                    type: "object",
                    properties: {
                        dataset_id: { type: "string", description: "The Galaxy Dataset ID to filter." },
                        pattern: { type: "string", description: "Regex or keyword to filter." }
                    },
                    required: ["dataset_id", "pattern"]
                }
            };

            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªç”Ÿç‰©ä¿¡æ¯åŠ©æ‰‹ã€‚
å½“å‰ä¸Šä¸‹æ–‡ï¼š
- æœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶ Dataset ID: "${lastUploadedDatasetId || 'æ— '}"ã€‚
- ç”¨æˆ·æ­£åœ¨å‘ä½ æé—®ã€‚

å¦‚æœç”¨æˆ·æƒ³è¦å¤„ç†æ–‡ä»¶ï¼ˆå¦‚è¿‡æ»¤ã€æœç´¢ï¼‰ï¼Œè¯·è¾“å‡º JSON æ ¼å¼çš„å·¥å…·è°ƒç”¨ã€‚
å¯ç”¨å·¥å…·ï¼š
${JSON.stringify([toolDef])}

å¦‚æœä¸éœ€è¦è°ƒç”¨å·¥å…·ï¼Œç›´æ¥ç”¨ä¸­æ–‡å›ç­”ã€‚
            `;

            try {
                // 5.2 è°ƒç”¨ Ollama
                const ollamaRes = await fetch(`${cfg.ollamaUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: cfg.model,
                        stream: false,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        format: "json" // å¼ºè¿«è¾“å‡º JSON (å¦‚æœæ¨¡å‹æ”¯æŒ)
                    })
                });

                if (!ollamaRes.ok) throw new Error('Ollama è¿æ¥å¤±è´¥');
                const ollamaJson = await ollamaRes.json();
                let content = ollamaJson.message.content;
                log(`LLM å›å¤: ${content}`);

                // 5.3 è§£æå†³ç­–
                let toolCall = null;
                try {
                    // å°è¯•æå– JSON
                    const match = content.match(/\{[\s\S]*\}/);
                    if (match) toolCall = JSON.parse(match[0]);
                } catch (e) {}

                if (toolCall && toolCall.tool === 'text_filter') {
                    // 5.4 å‘½ä¸­å·¥å…· -> æ‰§è¡Œ Galaxy æ˜ å°„é€»è¾‘
                    addMessage('assistant', `ğŸ¤– å†³ç­–: è°ƒç”¨ text_filter<br>å‚æ•°: ${JSON.stringify(toolCall.parameters)}`, true);
                    await runGalaxyTool(toolCall.parameters);
                } else {
                    // æ™®é€šå¯¹è¯
                    addMessage('assistant', content);
                }

            } catch (e) {
                addMessage('assistant', `âŒ é”™è¯¯: ${e.message}`);
            }
        }

        // --- 6. å·¥å…·æ‰§è¡Œä¸è½®è¯¢ ---
        async function runGalaxyTool(params) {
            const cfg = getConfig();
            const histId = await ensureHistory();

            // 6.1 åº”ç”¨ RAG æ˜ å°„ (æŸ¥è¡¨)
            // è¿™é‡Œå¯¹åº” constants.ts é‡Œçš„ mapping
            const payload = {
                tool_id: cfg.realToolId, // ä»å·¦ä¾§é…ç½®æ è¯»å–çœŸå® ID
                history_id: histId,
                inputs: {
                    'input': { src: 'hda', id: params.dataset_id }, // æ˜ å°„ dataset_id -> input
                    'cond': params.pattern // æ˜ å°„ pattern -> cond
                }
            };
            
            log(`å‘é€ Tool Payload: ${JSON.stringify(payload)}`);

            try {
                // 6.2 å‘é€æ‰§è¡Œè¯·æ±‚
                const toolRes = await galaxyFetch('/api/tools', 'POST', payload);
                const jobId = toolRes.jobs[0].id;
                addMessage('assistant', `ğŸš€ ä»»åŠ¡å·²æäº¤ (Job ID: ${jobId})ï¼Œæ­£åœ¨è½®è¯¢çŠ¶æ€...`, true);

                // 6.3 è½®è¯¢ (Polling)
                const pollInterval = setInterval(async () => {
                    try {
                        const job = await galaxyFetch(`/api/jobs/${jobId}`);
                        log(`Job Status: ${job.state}`);
                        
                        if (job.state === 'ok') {
                            clearInterval(pollInterval);
                            const outputId = job.outputs[0].id;
                            addMessage('assistant', `âœ… ä»»åŠ¡å®Œæˆï¼<br>ç»“æœæ•°æ®é›† ID: <b>${outputId}</b>`, true);
                        } else if (job.state === 'error') {
                            clearInterval(pollInterval);
                            addMessage('assistant', `âŒ ä»»åŠ¡å¤±è´¥ã€‚`, true);
                        }
                    } catch (err) {
                        clearInterval(pollInterval);
                        log(`Polling Error: ${err.message}`, 'error');
                    }
                }, 2000);

            } catch (e) {
                addMessage('assistant', `âŒ å·¥å…·è°ƒç”¨å¤±è´¥: ${e.message}`);
            }
        }
    </script>
</body>
</html>