<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Agent æç®€æ¼”ç¤ºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        .log-entry { font-family: monospace; font-size: 0.85em; border-left: 2px solid #555; padding-left: 8px; margin-top: 4px; color: #aaa; }
        /* Tooltip æ ·å¼ */
        .help-tip { cursor: help; border-bottom: 1px dotted #999; }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <!-- é¡¶éƒ¨æ ‡é¢˜ -->
    <header class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center gap-2 text-purple-400 font-bold text-xl">
            <i class="fas fa-dna"></i> Galaxy Agent Demo
        </div>
        <div class="text-xs text-gray-500">å•æ–‡ä»¶æ¼”ç¤ºç‰ˆ | <span class="text-gray-400">è¯·å…ˆåœ¨å·¦ä¾§é…ç½®ç¯å¢ƒ</span></div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <!-- å·¦ä¾§é…ç½®é¢æ¿ -->
        <aside class="w-1/3 min-w-[320px] bg-gray-800 p-4 overflow-y-auto border-r border-gray-700 shadow-xl z-10">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4 tracking-wider border-b border-gray-700 pb-2">
                <i class="fas fa-cogs"></i> ç¯å¢ƒé…ç½®
            </h2>
            
            <div class="space-y-5">
                <!-- Galaxy Config -->
                <div class="group">
                    <label class="block text-xs text-purple-400 font-bold mb-1">Galaxy URL</label>
                    <input id="cfg-galaxy-url" type="text" value="http://192.168.32.31" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-purple-500 transition-colors">
                    <p class="text-[10px] text-gray-500 mt-1">éœ€åœ¨ galaxy.yml ä¸­é…ç½® <code class="bg-gray-700 px-1">access_control_allow_origin: '*'</code></p>
                </div>

                <div class="group">
                    <label class="block text-xs text-purple-400 font-bold mb-1">
                        Galaxy API Key <span class="text-red-400">*</span>
                    </label>
                    <input id="cfg-api-key" type="password" placeholder="ç²˜è´´ä½ çš„ User API Key" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-purple-500 transition-colors outline-none">
                    <p class="text-[10px] text-gray-500 mt-1">è·å–æ–¹å¼: Galaxy ç½‘é¡µ -> User -> Preferences -> Manage API Key</p>
                </div>

                <!-- Ollama Config -->
                <div class="group">
                    <label class="block text-xs text-blue-400 font-bold mb-1">Ollama URL</label>
                    <input id="cfg-ollama-url" type="text" value="http://192.168.32.31:11434" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 transition-colors">
                    <p class="text-[10px] text-gray-500 mt-1">éœ€è®¾ç½®ç¯å¢ƒå˜é‡ <code class="bg-gray-700 px-1">OLLAMA_ORIGINS="*"</code></p>
                </div>

                <div class="group">
                    <label class="block text-xs text-blue-400 font-bold mb-1">
                        Ollama Model
                    </label>
                    <input id="cfg-model" type="text" value="gpt-oss:120b" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white focus:border-blue-500 transition-colors">
                    <p class="text-[10px] text-gray-500 mt-1">
                        éœ€ä¸æœåŠ¡å™¨ä¸€è‡´ã€‚æŸ¥çœ‹å‘½ä»¤: <code class="bg-gray-700 px-1 select-all">ollama list</code>
                    </p>
                </div>

                <hr class="border-gray-700 my-4">

                <h2 class="text-sm font-bold text-gray-400 uppercase mb-2 tracking-wider border-b border-gray-700 pb-2">
                    <i class="fas fa-book"></i> çŸ¥è¯†åº“ (RAG æ˜ å°„)
                </h2>
                <div class="bg-gray-900 p-3 rounded text-xs font-mono text-gray-400 border border-gray-700">
                    <p class="mb-2 text-green-400 font-bold">// æ¨¡æ‹Ÿ constants.ts æ˜ å°„è¡¨</p>
                    
                    <div class="mb-3">
                        <label class="block mb-1 text-gray-300 font-bold">Tool: Text Filter (Grep)</label>
                        <label class="block mb-1 text-gray-500 text-[10px]">çœŸå® Galaxy Tool ID:</label>
                        <input id="cfg-tool-id" type="text" value="Filter1" class="w-full bg-gray-800 border border-gray-600 rounded p-1 text-white text-xs focus:border-green-500">
                        <p class="text-[10px] text-yellow-500 mt-1">
                            <i class="fas fa-exclamation-triangle"></i> å¿…å¡«: è¯·åœ¨ Galaxy ç½‘é¡µä¸­æ‰¾åˆ°è¯¥å·¥å…·ï¼Œå¤åˆ¶å…¶å®Œæ•´ ID (é€šå¸¸å½¢å¦‚ toolshed.g2.bx.psu.edu/...)
                        </p>
                    </div>

                    <div class="pl-2 border-l-2 border-gray-700">
                        <p class="text-[10px] text-gray-500">å‚æ•°æ˜ å°„è§„åˆ™:</p>
                        <p class="text-[10px] text-gray-400">dataset_id -> "input" (hda_ref)</p>
                        <p class="text-[10px] text-gray-400">pattern -> "cond"</p>
                    </div>
                </div>
            </div>

            <div id="logs" class="mt-6 space-y-2 font-mono">
                <h3 class="text-xs font-bold text-gray-500 uppercase flex justify-between items-center">
                    ç³»ç»Ÿæ—¥å¿—
                    <button onclick="document.getElementById('logs').innerHTML='<h3 class=\'text-xs font-bold text-gray-500 uppercase flex justify-between items-center\'>ç³»ç»Ÿæ—¥å¿— <button onclick=\'clearLogs()\'>æ¸…ç©º</button></h3>'" class="text-[10px] hover:text-white">æ¸…ç©º</button>
                </h3>
                <!-- Logs will appear here -->
            </div>
        </aside>

        <!-- å³ä¾§èŠå¤©åŒº -->
        <main class="flex-1 flex flex-col bg-gray-900 relative">
            <div id="chat-box" class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="flex justify-start animate-fade-in-up">
                    <div class="bg-gray-800 p-4 rounded-xl rounded-bl-none max-w-[80%] border border-gray-700 shadow-lg">
                        <h3 class="font-bold text-purple-400 mb-2"><i class="fas fa-robot"></i> Galaxy Agent</h3>
                        <p class="text-sm text-gray-300">ä½ å¥½ï¼æˆ‘æ˜¯ç”Ÿç‰©ä¿¡æ¯å­¦åŠ©æ‰‹ã€‚</p>
                        <ol class="list-decimal list-inside text-sm text-gray-400 mt-2 space-y-1">
                            <li>è¯·å…ˆåœ¨å·¦ä¾§å¡«å…¥ <b>Galaxy API Key</b>ã€‚</li>
                            <li>ç¡®è®¤ <b>Ollama Model</b> ä¸æœåŠ¡å™¨ (<code class="text-xs bg-gray-900 px-1">ollama list</code>) ä¸€è‡´ã€‚</li>
                            <li>ç¡®è®¤ <b>Tool ID</b> ä¸ Galaxy ç½‘é¡µä¸€è‡´ã€‚</li>
                            <li>ç‚¹å‡»ä¸‹æ–¹å›å½¢é’ˆä¸Šä¼ æ–‡ä»¶ï¼Œç„¶åå¯¹æˆ‘ä¸‹è¾¾æŒ‡ä»¤ã€‚</li>
                        </ol>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 flex gap-3 items-center shadow-2xl z-20">
                <input type="file" id="file-upload" class="hidden" onchange="handleFileUpload(this)">
                <button onclick="document.getElementById('file-upload').click()" class="p-3 bg-gray-700 hover:bg-gray-600 rounded-xl text-white transition duration-200 group relative" title="ä¸Šä¼ æ–‡ä»¶">
                    <i class="fas fa-paperclip group-hover:text-purple-400"></i>
                </button>
                <div class="flex-1 relative">
                    <input id="user-input" type="text" placeholder="è¾“å…¥æŒ‡ä»¤ (ä¾‹å¦‚: è¿‡æ»¤åŒ…å« gene_A çš„è¡Œ)" class="w-full bg-gray-900 text-white p-3 pr-10 rounded-xl border border-gray-600 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all shadow-inner" onkeydown="if(event.key==='Enter') sendMessage()">
                    <i class="fas fa-keyboard absolute right-3 top-4 text-gray-600"></i>
                </div>
                <button onclick="sendMessage()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 rounded-xl text-white font-bold shadow-lg transition transform hover:scale-105 active:scale-95">
                    å‘é€ <i class="fas fa-paper-plane ml-1"></i>
                </button>
            </div>
        </main>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        let currentHistoryId = null;
        let lastUploadedDatasetId = null;

        function clearLogs() {
             const logs = document.getElementById('logs');
             // ä¿ç•™æ ‡é¢˜ï¼Œæ¸…ç©ºå†…å®¹ (ç®€å•å®ç°ï¼šåˆ·æ–°é¡µé¢æˆ–é‡ç½®innerHTML)
             // è¿™é‡Œçš„HTMLç»“æ„æœ‰ç‚¹hardcodeï¼Œä¸ºäº†ç®€å•èµ·è§
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šå†™æ—¥å¿— ---
        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = 'log-entry break-all';
            const color = type === 'error' ? 'text-red-400 border-red-900' : (type === 'success' ? 'text-green-400 border-green-900' : 'text-gray-500 border-gray-700');
            entry.style.borderLeft = `3px solid ${type === 'error' ? '#ef4444' : (type === 'success' ? '#22c55e' : '#6b7280')}`;
            
            entry.innerHTML = `<span class="text-[10px] opacity-50">[${new Date().toLocaleTimeString()}]</span> <span class="${color}">${msg}</span>`;
            logs.prepend(entry);
        }

        // --- è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ èŠå¤©æ°”æ³¡ ---
        function addMessage(role, content, isHtml = false) {
            const box = document.getElementById('chat-box');
            const row = document.createElement('div');
            row.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubble = document.createElement('div');
            // æ ·å¼ä¼˜åŒ–
            bubble.className = role === 'user' 
                ? 'bg-gradient-to-br from-purple-600 to-blue-600 text-white p-3 rounded-2xl rounded-br-none max-w-[80%] shadow-md text-sm' 
                : 'bg-gray-800 text-gray-200 p-3 rounded-2xl rounded-bl-none max-w-[80%] border border-gray-700 shadow-md text-sm';
            
            if (isHtml) bubble.innerHTML = content;
            else bubble.textContent = content;

            row.appendChild(bubble);
            box.appendChild(row);
            box.scrollTop = box.scrollHeight;
        }

        // --- 1. è·å–é…ç½® ---
        function getConfig() {
            return {
                galaxyUrl: document.getElementById('cfg-galaxy-url').value.replace(/\/$/, ''),
                apiKey: document.getElementById('cfg-api-key').value,
                ollamaUrl: document.getElementById('cfg-ollama-url').value.replace(/\/$/, ''),
                model: document.getElementById('cfg-model').value,
                realToolId: document.getElementById('cfg-tool-id').value // çŸ¥è¯†åº“ä¸­çš„åŠ¨æ€éƒ¨åˆ†
            };
        }

        // --- 2. Galaxy API äº¤äº’ ---
        async function galaxyFetch(endpoint, method = 'GET', body = null) {
            const cfg = getConfig();
            if (!cfg.apiKey) { alert('è¯·å…ˆåœ¨å·¦ä¾§é…ç½® Galaxy API Key!'); throw new Error('No API Key'); }
            
            const opts = {
                method,
                headers: { 'x-api-key': cfg.apiKey, 'Content-Type': 'application/json' }
            };
            if (body) opts.body = JSON.stringify(body);

            try {
                const res = await fetch(`${cfg.galaxyUrl}${endpoint}`, opts);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`Status ${res.status}: ${text}`);
                }
                return await res.json();
            } catch (e) {
                log(`API Error: ${e.message}`, 'error');
                throw e;
            }
        }

        // --- 3. åˆå§‹åŒ–/è·å– History ---
        async function ensureHistory() {
            if (currentHistoryId) return currentHistoryId;
            log('æ­£åœ¨è¿æ¥ Galaxy è·å– History...');
            try {
                const hists = await galaxyFetch('/api/histories?order=update_time');
                if (hists.length > 0) {
                    currentHistoryId = hists[0].id;
                    log(`å¤ç”¨æœ€è¿‘ History: ${hists[0].name}`, 'success');
                } else {
                    const newHist = await galaxyFetch('/api/histories', 'POST', { name: 'Demo Session ' + new Date().toISOString() });
                    currentHistoryId = newHist.id;
                    log(`åˆ›å»ºæ–° History: ${newHist.id}`, 'success');
                }
                return currentHistoryId;
            } catch (e) {
                log('æ— æ³•è¿æ¥ Galaxyï¼Œè¯·æ£€æŸ¥ URL å’Œ CORS é…ç½®', 'error');
                throw e;
            }
        }

        // --- 4. ä¸Šä¼ æ–‡ä»¶ ---
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const cfg = getConfig();
            if (!cfg.apiKey) return alert("è¯·å…ˆå¡«å†™ Galaxy API Key");

            addMessage('user', `ğŸ“„ ä¸Šä¼ æ–‡ä»¶: ${file.name}`);
            addMessage('assistant', `æ­£åœ¨ä¸Šä¼ åˆ° Galaxy... <i class="fas fa-circle-notch fa-spin"></i>`, true);

            try {
                const histId = await ensureHistory();
                const text = await file.text(); // ç®€åŒ–æ¼”ç¤ºï¼šåªå¤„ç†æ–‡æœ¬

                // æ„é€  Galaxy upload payload
                const payload = {
                    tool_id: 'upload1',
                    history_id: histId,
                    inputs: {
                        'files_0|type': 'upload_dataset',
                        'files_0|NAME': file.name,
                        'files_0|url_paste': text,
                        'dbkey': '?',
                        'file_type': 'auto',
                    }
                };

                const res = await galaxyFetch('/api/tools', 'POST', payload);
                const datasetId = res.outputs[0].id;
                lastUploadedDatasetId = datasetId;
                
                log(`ä¸Šä¼ å®Œæˆ ID: ${datasetId}`, 'success');
                addMessage('assistant', `âœ… ä¸Šä¼ æˆåŠŸï¼<br>Dataset ID: <code class="bg-black/30 px-1 rounded">${datasetId}</code><br>ä½ å¯ä»¥è¯´: "å¸®æˆ‘è¿‡æ»¤è¿™ä¸ªæ–‡ä»¶"`, true);

            } catch (e) {
                addMessage('assistant', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`);
            }
        }

        // --- 5. ä¸»æµç¨‹ï¼šLLM å†³ç­– + å·¥å…·æ‰§è¡Œ ---
        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            if (!text) return;
            
            inputEl.value = '';
            addMessage('user', text);
            addMessage('assistant', `æ€è€ƒä¸­... <i class="fas fa-brain fa-pulse text-purple-400"></i>`, true);

            const cfg = getConfig();

            // 5.1 æ„é€  Prompt (In-Context RAG)
            const toolDef = {
                name: "text_filter",
                description: "Filter lines in a dataset based on a pattern. Use this when user wants to search, grep, or find specific text.",
                parameters: {
                    type: "object",
                    properties: {
                        dataset_id: { type: "string", description: "The Galaxy Dataset ID to filter. MUST be from context." },
                        pattern: { type: "string", description: "Regex or keyword to filter." }
                    },
                    required: ["dataset_id", "pattern"]
                }
            };

            const systemPrompt = `
You are a Bioinformatics Agent.
Current Context:
- Last Uploaded File ID: "${lastUploadedDatasetId || 'None'}".
- User Input: "${text}".

Instructions:
1. If the user wants to process data (filter, search), return a JSON object calling the 'text_filter' tool.
2. If the user is just chatting, reply in Chinese.

Available Tools:
${JSON.stringify([toolDef])}

Response Format:
Just the JSON or just the text. No markdown block.
            `;

            try {
                // 5.2 è°ƒç”¨ Ollama
                const ollamaRes = await fetch(`${cfg.ollamaUrl}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: cfg.model,
                        stream: false,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        format: "json" 
                    })
                });

                if (!ollamaRes.ok) throw new Error(`Ollama Error: ${ollamaRes.statusText}`);
                const ollamaJson = await ollamaRes.json();
                let content = ollamaJson.message.content;
                log(`LLM Raw: ${content.substring(0, 50)}...`);

                // 5.3 è§£æå†³ç­–
                let toolCall = null;
                try {
                    // å°è¯•æå– JSON
                    const match = content.match(/\{[\s\S]*\}/);
                    if (match) toolCall = JSON.parse(match[0]);
                    // å…¼å®¹ Ollama æœ‰æ—¶æŠŠ tool æ”¾åœ¨å¤–é¢çš„æƒ…å†µ
                    if (toolCall && !toolCall.tool && toolCall.name) toolCall.tool = toolCall.name; 
                } catch (e) {}

                if (toolCall && (toolCall.tool === 'text_filter' || toolCall.name === 'text_filter')) {
                    // 5.4 å‘½ä¸­å·¥å…· -> æ‰§è¡Œ Galaxy æ˜ å°„é€»è¾‘
                    addMessage('assistant', `ğŸ¤– <b>å†³ç­–å¼•æ“</b>: è¯†åˆ«åˆ°å·¥å…·è°ƒç”¨è¯·æ±‚ã€‚<br>å·¥å…·: <span class="text-green-400">text_filter</span><br>å‚æ•°: <pre class="text-xs bg-black/30 p-1 mt-1">${JSON.stringify(toolCall.parameters || toolCall.arguments, null, 2)}</pre>`, true);
                    
                    // å‚æ•°å…¼å®¹
                    const params = toolCall.parameters || toolCall.arguments;
                    if(!params.dataset_id) params.dataset_id = lastUploadedDatasetId;

                    await runGalaxyTool(params);
                } else {
                    // æ™®é€šå¯¹è¯
                    // å¦‚æœæ˜¯ JSON æ ¼å¼çš„é—²èŠï¼Œæå– content
                    if (toolCall && toolCall.message) content = toolCall.message;
                    addMessage('assistant', content);
                }

            } catch (e) {
                addMessage('assistant', `âŒ é”™è¯¯: ${e.message}`);
                log(e.message, 'error');
            }
        }

        // --- 6. å·¥å…·æ‰§è¡Œä¸è½®è¯¢ ---
        async function runGalaxyTool(params) {
            const cfg = getConfig();
            const histId = await ensureHistory();

            if (!params.dataset_id) {
                addMessage('assistant', 'âŒ é”™è¯¯: ç¼ºå°‘ Dataset IDï¼Œè¯·å…ˆä¸Šä¼ æ–‡ä»¶ã€‚', true);
                return;
            }

            // 6.1 åº”ç”¨ RAG æ˜ å°„ (æŸ¥è¡¨)
            // è¿™é‡Œå¯¹åº” constants.ts é‡Œçš„ mapping
            const payload = {
                tool_id: cfg.realToolId, // ä»å·¦ä¾§é…ç½®æ è¯»å–çœŸå® ID
                history_id: histId,
                inputs: {
                    'input': { src: 'hda', id: params.dataset_id }, // æ˜ å°„ dataset_id -> input
                    'cond': params.pattern // æ˜ å°„ pattern -> cond
                }
            };
            
            log(`Tool API Request: ${JSON.stringify(payload)}`);

            try {
                // 6.2 å‘é€æ‰§è¡Œè¯·æ±‚
                const toolRes = await galaxyFetch('/api/tools', 'POST', payload);
                const jobId = toolRes.jobs[0].id;
                addMessage('assistant', `ğŸš€ <b>Galaxy æ‰§è¡Œä¸­</b><br>Job ID: ${jobId}<br>æ­£åœ¨è½®è¯¢çŠ¶æ€...`, true);

                // 6.3 è½®è¯¢ (Polling)
                const pollInterval = setInterval(async () => {
                    try {
                        const job = await galaxyFetch(`/api/jobs/${jobId}`);
                        
                        if (job.state === 'ok') {
                            clearInterval(pollInterval);
                            const outputId = job.outputs[0].id;
                            log(`Job Finished: ${outputId}`, 'success');
                            addMessage('assistant', `âœ… <b>ä»»åŠ¡å®Œæˆ</b><br>ç»“æœå·²ç”Ÿæˆ (Dataset ID: ${outputId})<br>è¯·åœ¨ Galaxy å†å²è®°å½•ä¸­æŸ¥çœ‹è¯¦ç»†ç»“æœã€‚`, true);
                        } else if (job.state === 'error') {
                            clearInterval(pollInterval);
                            addMessage('assistant', `âŒ ä»»åŠ¡æ‰§è¡Œå¤±è´¥ (State: error)ã€‚`, true);
                        } else {
                            log(`Job State: ${job.state}...`);
                        }
                    } catch (err) {
                        clearInterval(pollInterval);
                        log(`Polling Error: ${err.message}`, 'error');
                    }
                }, 2000);

            } catch (e) {
                addMessage('assistant', `âŒ å·¥å…· API è°ƒç”¨å¤±è´¥: ${e.message}<br><span class="text-xs text-gray-500">å¯èƒ½æ˜¯ Tool ID ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥å·¦ä¾§é…ç½®ã€‚</span>`, true);
            }
        }
    </script>
</body>
</html>